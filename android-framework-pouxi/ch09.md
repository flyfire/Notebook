### 9.Framework的启动过程

Linux系统启动过程的最后,内核将读取init.rc文件,并启动该文件中定义的各种服务程序.由于Android系统相对于Linux内核而言仅仅是一个Linux应用程序而已,因此,该程序也是在init.rc中被声明,从而当Linux内核启动后能够接着运行Android内核.

系统中运行的第一个Dalvik虚拟机程序叫做zygote,接下来的所有Dalvik虚拟机进程都是通过这个zygote孵化出来的.zygote进程中包含两个主要模块,分别如下:

+ Socket服务端.该Socket服务端用于接收启动新的Dalvik进程的命令
+ Framework共享类及共享资源.当zygote进程启动后,会装载一些共享的类及资源,其中共享类是在preload-classes文件中被定义,共享资源是在preload-resources中被定义.因为zygote进程用于孵化出其他Dalvik进程,因此,这些类和资源装载后,新的Dalvik进程就不需要再装载这些类和资源了,这也就是所谓的共享.

zygote进程对应的具体程序是app_process,该程序存在于system/bin目录下,启动该程序的指令是在init.rc中进行配置的.

zygote孵化出的第一个Dalvik进程叫做SystemServer,SystemServer仅仅是该进程的别名,而该进程具体对应的程序依然是app_process,因为SystemServer是从app_process中孵化出来的.SystemServer中创建了一个Socket客户端,并有AMS负责管理该客户端,之后所有的Dalvik进程都将通过该Socket客户端间接被启动.当需要启动新的APK进程时,AMS中会通过该Socket客户端向zygote进程的Socket服务端发送一个启动命令,然后zygote会孵化出新的进程.

从系统架构的角度来讲,就在于此即先创建一个zygote,并加载共享类和资源,然后通过该zygote去孵化新的Dalvik进程,该架构的特点有两个.

+ 每一个进程都是一个Dalvik虚拟机
+ zygote进程预先会装载共享类和共享资源,这些类及资源实际上就是SDK中定义的大部分类和资源.因此,当通过zygote孵化出新的进程后,新的APK进程只需要去装载APK自身包含的类和资源即可,这就有效地解决了多个APK共享Framework资源的问题.

``dalvikvm``的执行语法为``dalvikvm -cp 类路径 类名``,``dalvikvm``的作用就是创建一个虚拟机并执行参数中指定的Java类.

``dvz``的作用是从zygote进程中孵化出一个新的进程,新的进程也是一个Dalvik虚拟机.该进程与``dalvikvm``启动的虚拟机相比,区别在于该进程中已经预装了Framework的大部分类和资源.

``dvz -classpath /data/app/solarex.apk com.solarexsoft.demo.Main``,``dvz``的语法是``dvz -classpath 包名称 类名``.一个APK的入口类是ActivityThread类,Activity类仅仅是被回调的类,因此不可以通过Activity类来启动一个APK.

Framework在启动时需要加载运行两个特定Java类,一个是ZygoteInit.java,另一个是SystemServer.java.为了便于使用,系统提供了一个app_process进程,该进程会自动运行这两个类,从这个角度来讲,app_process的本质就是使用dalvikvm启动ZygoteInit.java,并在启动后加载Framework中的大部分类和资源.
