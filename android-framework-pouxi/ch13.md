### 13.View工作原理

用户通过触摸屏或键盘灯输入设备产生输入消息，该消息首先被消息处理前端转换为更明确的消息值。接下来，窗口管理系统WMS根据所有窗口的状态判断用户正在与哪个窗口进行交互，然后把该消息发送给当前窗口。因为窗口是由WMS创建的，因此WMS知道所有客户窗口的信息，包括窗口的大小、位置等。当消息到达时，如果是按键消息，则直接发送给当前窗口，如果是触摸消息，则WMS会根据消息的位置坐标去匹配所有的窗口，判断该坐标落到了哪个窗口区域中，然后把该消息发送给相应的窗口。最后，消息顺利到达目标窗口，至于目标窗口内部如何处理该消息则完全是窗口的“内政”。

View系统获得消息后，会按照默认的逻辑来派发消息，主要就是把该消息派发给所有的子视图，以便相应的子视图能够获得消息并执行不同的任务。

重绘界面的过程大致分为三步：

+ 测量measure，即测量出所有视图的实际尺寸大小。并不是所有导致界面重绘的操作都需要重新计算窗口的大小，在View的内部逻辑中，使用了一个内部变量保存相应的状态，当用户的某个操作导致改变了视图大小时，会设置该变量，而View的内部逻辑会根据该变量，决定是否需要重新测量。
+ 布局layout，即应该把视图放在屏幕的什么位置上。视图必须要有一个位置，该位置坐标相对于其父视图。不同视图的位置可以重叠，View系统本身并不限定子视图的位置。
+ 绘制draw，把视图绘制到屏幕上，当系统获知了窗口中所有视图的大小和位置后，就可以完全确定屏幕上应该显示哪些视图了。在绘制时，系统内部为每一个窗口创建了一个Canvas对象，并把这个Canvas对象传递给从根视图到所有子视图。View系统将Canvas传递给子视图时，都先将对该画布进行一次裁剪clip，从而在子视图看来，总是从画布的(0,0)坐标开始绘制。

